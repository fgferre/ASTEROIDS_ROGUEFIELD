> [!NOTE]
Documento arquivado em 2025-10-10. Itens rastreados no novo plano: Se√ß√£o 4.1 Migra√ß√£o DI + WaveManager. Consulte `docs/plans/docs-implementation-master-plan.md` para objetivos e crit√©rios atualizados.

# Phase 2.2: Enemy System Decomposition - Branch README

> ‚ö†Ô∏è **Arquivo hist√≥rico** ‚Äî este README foi movido para `docs/guides/archive/phase-2-2/` apenas para refer√™ncia durante a revis√£o de documenta√ß√£o de 2025-10-09. Consulte `docs/guides/phase-2-2-actual-state.md` para o retrato atual da fase.

**Branch:** `feature/phase-2-2-enemy-decomposition`
**Status:** ‚ö†Ô∏è Foundation Complete, Partial Implementation
**Date:** 2025-10-01

---

## üìä Quick Status

| Component | Status | Active? | Lines | Usage |
|-----------|--------|---------|-------|-------|
| RewardManager | ‚úÖ Complete | Yes | 339 | 100% |
| AsteroidCollision | ‚úÖ Complete | Yes | 241 | 100% |
| AsteroidRenderer | ‚úÖ Complete | Yes | 201 | 100% |
| AsteroidMovement | ‚úÖ Integrated (movement) | Yes | 222 | 100% |
| WaveManager | ‚ö†Ô∏è Pending integration | Constructor only | 447 | 0% |
| EnemyFactory | ‚ùå Disabled | No | 428 | 0% |

**Overall:** 4/6 componentes ativos (WaveManager pendente, EnemyFactory desativada)

---

## ‚úÖ What You Can Use Now

### 1. RewardManager - FULLY FUNCTIONAL

Automatically drops XP orbs when enemies are destroyed.

**Integration:**
```javascript
// Already integrated via event system
gameEvents.on('enemy-destroyed', (data) => {
  rewardManager.dropRewards(data.enemy);
});
```

**Features:**
- XP calculation based on enemy type, size, variant
- Scatter effect when orbs spawn
- Statistics tracking
- Configurable reward tables

### 2. AsteroidCollision - FUNCTIONAL

Handles asteroid-to-asteroid physics.

**Usage:**
```javascript
// EnemySystem automatically uses it
if (this.useComponents && this.collisionComponent) {
  this.collisionComponent.handleAsteroidCollisions(this.asteroids);
}
```

**Features:**
- Elastic collision physics
- Penetration correction
- Mass-based impulse
- Rotation effects

**‚ö†Ô∏è Note:** Legacy collision code still exists (needs cleanup)

### 3. AsteroidRenderer - FUNCTIONAL (Limited)

Organizes rendering and adds debug features.

**Usage:**
```javascript
// EnemySystem automatically uses it
if (this.useComponents && this.rendererComponent) {
  this.rendererComponent.renderAll(ctx, this.asteroids);
}
```

**Features:**
- Batch rendering organization
- Debug mode with bounding boxes
- Velocity vectors
- Rendering statistics

**‚ö†Ô∏è Note:** Delegates to `asteroid.draw()`, doesn't refactor rendering logic

### 4. AsteroidMovement - FUNCTIONAL (Movement Delegated)

Handles velocity updates through the component pipeline. Visual timers and
special behaviours remain in the asteroid type where needed.

**Usage:**
```javascript
if (this.useComponents && this.movementComponent) {
  this.movementComponent.update(asteroid, deltaTime, context);
}
```

**Highlights:**
- Movement strategies (linear/parasite/volatile) now run from the component.
- Screen wrapping and physics integration handled centrally.
- EnemySystem still calls `asteroid.updateVisualState()` and behaviour timers
  after movement so legacy visuals are preserved.

**Follow-up:** Audit remaining helpers in `Asteroid.js` to retire any
duplicated velocity code.

---

## ‚ùå What Still Needs Work

### WaveManager - Pending Integration

**State:** Constructor runs (`new WaveManager(this, gameEvents)`), but the main
update loop still calls legacy `updateWaveLogic()` on `EnemySystem`. Feature flag
`useManagers` stays `true` to keep RewardManager active, yet wave progression is
unchanged.

**Next steps:**
- Route wave timing through `waveManager.update(deltaTime)`.
- Migrate spawn control and state broadcasting out of `EnemySystem`.
- Delete the redundant legacy wave helpers once parity is confirmed.

### EnemyFactory - Disabled Feature Flag

**State:** `useFactory = false` blocks runtime usage even though the factory is
constructed and registers the `asteroid` type.

**Next steps:**
- Investigate pool conflicts when toggling `useFactory` to `true`.
- Confirm lifecycle hooks with `GamePools.configureAsteroidLifecycle()`.
- Re-evaluate whether factory adds value versus direct constructors.

---

## üéØ Integration Guide

### If You Want to Merge This Branch

The branch is **safe to merge** because:
- ‚úÖ Zero breaking changes
- ‚úÖ Game works perfectly
- ‚úÖ RewardManager adds value
- ‚úÖ Collision/Rendering improvements active
- ‚úÖ Feature flags allow rollback

**Merge Steps:**
```bash
# 1. Test the game thoroughly
npm run build
npm run dev  # Test gameplay

# 2. Merge to main
git checkout main
git merge feature/phase-2-2-enemy-decomposition

# 3. Optional: Remove dead code first (recommended)
# See docs/guides/phase-2-2-actual-state.md for details
```

### If You Want to Complete Implementation

Follow the roadmap in `docs/guides/phase-2-2-actual-state.md`:

**Foco atual:**

**Phase 2.2.1: Integrar WaveManager (2-3h)**
- Plugar `waveManager.update(deltaTime)` no loop principal.
- Migrar spawn/broadcast da wave do `EnemySystem` para o manager.
- Validar telemetria de ondas e limpar duplicatas legadas.

**Phase 2.2.2: Revisar EnemyFactory (2h)**
- Reproduzir conflito com `useFactory = true` e ajustar integra√ß√£o com `GamePools`.
- Definir pol√≠tica de ciclo de vida (quem inicializa/recicla inst√¢ncias).
- Documentar decis√£o: manter ou remover Factory.

**Phase 2.2.3: Cleanup Final (1-2h)**
- Remover utilit√°rios de colis√£o legados (`checkAsteroidCollision`).
- Consolidar fun√ß√µes residuais de movimento em `AsteroidMovement`.
- Atualizar checklist de testes com os novos caminhos ativos.

---

## üìö Documentation

### Main Documents

1. **[phase-2-2-completion-report.md](docs/guides/phase-2-2-completion-report.md)**
   - Original (optimistic) completion report
   - Describes intended architecture

2. **[phase-2-2-actual-state.md](docs/guides/phase-2-2-actual-state.md)** ‚≠ê
   - **START HERE** - Honest assessment
   - Real implementation status
   - Detailed analysis
   - Roadmap for improvements

3. **[archive/phase-2-2/README.md](docs/guides/archive/phase-2-2/README.md)**
   - Hist√≥rico dos planos originais
   - Links para estrat√©gias antigas (agora arquivadas)
   - √ötil para entender decis√µes anteriores

### Component Documentation

Each component has full JSDoc:
- `src/modules/enemies/components/AsteroidMovement.js`
- `src/modules/enemies/components/AsteroidCollision.js`
- `src/modules/enemies/components/AsteroidRenderer.js`
- `src/modules/enemies/managers/RewardManager.js`
- `src/modules/enemies/managers/WaveManager.js`

---

## üîß Development Tips

### Feature Flags

Control what's active:

```javascript
// In EnemySystem.js constructor:
this.useManagers = true;     // RewardManager ON; WaveManager ainda sem update()
this.useComponents = true;   // Movement/Collision/Renderer ON
this.useFactory = false;     // Factory OFF (pool conflict em investiga√ß√£o)
```

### Debugging

Enable debug rendering:

```javascript
// In browser console:
const enemies = gameServices.get('enemies');
enemies.rendererComponent.setDebugMode(true);
enemies.rendererComponent.setShowBoundingCircles(true);
enemies.rendererComponent.setShowVelocityVectors(true);
```

### Testing Changes

```bash
# Build and test
npm run build
npm run dev

# Check for errors in browser console
# Look for:
# - "[EnemySystem] ... initialized" messages
# - No errors during gameplay
# - XP orbs dropping correctly
# - Asteroids colliding correctly
```

---

## üêõ Known Issues

### 1. WaveManager sem loop ativo

**Issue:** `WaveManager` inicializa mas nunca recebe `update()`.

**Impact:** L√≥gica de ondas segue duplicada no `EnemySystem`, o que dificulta
o ajuste de dificuldade.

**Fix:** Encaminhar o loop para o manager, migrar contadores e remover helpers
legados.

### 2. EnemyFactory desativada

**Issue:** `useFactory = false` impede validar o fluxo baseado em f√°brica.

**Impact:** Sem consenso sobre ciclo de vida dos inimigos; dificulta expandir
para novos tipos.

**Fix:** Investigar conflito com pools, decidir entre ativar ou remover.

### 3. C√≥digo duplicado de colis√£o

**Issue:** `EnemySystem.checkAsteroidCollision()` permanece como fallback
mesmo com o componente ativo.

**Impact:** Dobra pontos de manuten√ß√£o e pode gerar diverg√™ncias sutis.

**Fix:** Remover fallback ap√≥s confirmar estabilidade do componente.

---

## üìã Commit History

```
34a8110 - docs: add honest assessment of Phase 2.2 actual state
0bd4e1f - docs: add Phase 2.2 completion report
79160a9 - feat: integrate managers and create component architecture (Phase 2.2)
6ef87aa - feat: create WaveManager and RewardManager
5cf981c - refactor: extract Asteroid class to extensible architecture
1d80c07 - feat: create extensible enemy foundation (Phase 2.2)
```

---

## üéØ Recommendations

### For Production

**MERGE AS IS** if:
- Voc√™ quer RewardManager + componentes ativos agora.
- Aceita manter WaveManager em backlog por enquanto.
- Planeja revisar EnemyFactory quando houver tempo dedicado.

**WAIT AND CLEANUP** if:
- Prefere consolidar WaveManager antes de seguir.
- Precisa validar EnemyFactory para novos tipos de inimigo.
- Quer eliminar utilit√°rios legados (colis√£o/movimento) no mesmo ciclo.

### For Development

**Continue Implementation** if:
- Est√° pronto para integrar WaveManager e revisar EnemyFactory.
- Tem 5-8 horas para reduzir o `EnemySystem` removendo l√≥gica duplicada.
- Quer destravar novos tipos de inimigo orientados a dados.

**Simplify and Accept** if:
- Arquitetura atual atende ao roadmap imediato.
- Prefere focar em outras features (HUD, armas, etc.).
- Pode conviver com WaveManager legado por mais algum tempo.

---

## ü§ù Contributing

If you want to help complete this phase:

1. Read `docs/guides/phase-2-2-actual-state.md`
2. Pick a task from the roadmap
3. Create a new branch from this one
4. Implement incrementally with tests
5. Submit PR with clear description

**Important:** Test thoroughly - zero breaking changes is the rule!

---

## ‚ùì FAQ

**Q: Is it safe to merge?**
A: Yes! Game works perfectly, zero breaking changes.

**Q: Why wasn't everything completed?**
A: Scope was too large, integration was harder than expected, some components couldn't be easily activated without major refactoring.

**Q: Should I remove the dead code?**
A: Recommended but not required. See cleanup guide in actual-state doc.

**Q: Will the roadmap be followed?**
A: Up to you! It's there as a guide if you want to complete it.

**Q: What's the best outcome from this phase?**
A: RewardManager is excellent and fully functional. That alone is valuable.

---

**Last Updated:** 2025-10-01
**Maintainer:** Development Team
**Status:** Ready for decision (merge or continue)

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
