> [!NOTE]
Documento arquivado em 2025-10-10. Itens rastreados no novo plano: Se√ß√£o 3.1 Sistema de recompensas e orbs. Consulte `docs/plans/docs-implementation-master-plan.md` para objetivos e crit√©rios atualizados.

# An√°lise Completa: Sistema de Drops de XP Orbs

**Revis√£o:** 2025-10-05  
**Status:** ‚úÖ Fluxo √∫nico controlado pelo RewardManager

---

## üîç Resumo Executivo

O fluxo de drops de XP foi centralizado no `RewardManager`. O sistema antigo de drops do `XPOrbSystem` permanece ativo apenas como gestor do ciclo de vida dos orbs (pooling, magnetismo, fus√£o e renderiza√ß√£o). N√£o existem mais dois listeners respondendo a `enemy-destroyed`; em vez disso, o `EnemySystem` encaminha o evento ao `RewardManager`, que calcula os drops e delega a cria√ß√£o f√≠sica de cada orb para o `XPOrbSystem`.

---

## üß© Fluxo de Eventos Atual

```
Asteroide destru√≠do
    ‚îÇ
    ‚îî‚îÄ> EnemySystem listener
         ‚îî‚îÄ> RewardManager.dropRewards(enemy)
              ‚îú‚îÄ> Calcula quantidade + valor de XP por orb
              ‚îú‚îÄ> createXPOrbs(enemy, count, value)
              ‚îÇ     ‚îî‚îÄ> XPOrbSystem.createXPOrb(x, y, xpPerOrb, metadata)
              ‚îî‚îÄ> tryDropHealthHeart(enemy)
```

### Pontos-chave do fluxo
- `EnemySystem` garante que o `RewardManager` seja criado com uma inst√¢ncia v√°lida de `XPOrbSystem` antes de processar destrui√ß√µes de inimigos.  
- `RewardManager.dropRewards` √© a **√∫nica** fonte de decis√£o de drops (XP, cora√ß√µes, futuros itens).  
- `XPOrbSystem.createXPOrb` apenas instancia e registra orbs; toda a l√≥gica de quando e quantos orbs gerar fica fora do sistema.

---

## üõ†Ô∏è RewardManager.dropRewards

`RewardManager.dropRewards(enemy)` executa tr√™s passos principais:

1. **Recuperar configura√ß√£o do inimigo:** l√™ `rewardConfigs` (alimentado por `GameConstants`) para obter valor base, contagem de orbs, fatores por tamanho e multiplicadores por variante.
2. **Aplicar escalonamento:** combina tamanho, variante e b√¥nus de wave (`+1` orb a cada 5 waves at√© a wave 10; depois escala a cada 3 waves) para definir o n√∫mero final de orbs e o XP total.  
3. **Delegar cria√ß√£o:** chama `createXPOrbs`, que por sua vez itera e envia chamadas a `XPOrbSystem.createXPOrb` com metadados do inimigo (tipo, tamanho, variante, velocidade inicial). Tamb√©m registra estat√≠sticas e tenta dropar cora√ß√µes.

Esse design garante que qualquer novo tipo de recompensa seja controlado em um √∫nico lugar, mantendo o `XPOrbSystem` focado na mec√¢nica dos orbs.

---

## üèóÔ∏è Papel Atual do XPOrbSystem

O `XPOrbSystem` continua sendo respons√°vel por:
- Pooling e reciclagem de entidades de orb.
- Magnetismo em rela√ß√£o √† nave do jogador.
- Fus√£o de orbs pr√≥ximos e anima√ß√µes relacionadas.
- Emiss√£o de eventos `xp-orb-created` quando um orb √© instanciado.

O arquivo cont√©m um coment√°rio de arquitetura destacando que as decis√µes de drop agora pertencem ao `RewardManager`, enquanto o `XPOrbSystem` apenas gerencia o ciclo de vida dos orbs. Esse coment√°rio √© a refer√™ncia oficial para manter a separa√ß√£o de responsabilidades.

---

## üìå Responsabilidades Resumidas

| Sistema | Responsabilidades | Observa√ß√µes |
| --- | --- | --- |
| RewardManager | Calcula recompensas, decide drops, aciona cria√ß√£o de orbs e cora√ß√µes, atualiza estat√≠sticas. | Centraliza toda l√≥gica de recompensas e escala por wave. |
| XPOrbSystem | Gerencia inst√¢ncias de orbs, f√≠sica leve, magnetismo, fus√£o e renderiza√ß√£o. | Recebe pedidos via `createXPOrb` e n√£o escuta mais `enemy-destroyed`. |

---

## ‚úÖ Valida√ß√£o Recomendada

1. **Logs do RewardManager:** habilitar os `console.log` existentes em `RewardManager.createXPOrbs` para verificar a quantidade de orbs criados por inimigo e confirmar que apenas esse sistema reporta drops de XP.
2. **Stress test r√°pido:** executar `npm run quick-performance-test` ap√≥s destruir m√∫ltiplos asteroides para confirmar que a contagem de orbs permanece consistente e que n√£o h√° explos√£o de entidades.
3. **M√©trica manual:** no modo de desenvolvimento, eliminar uma sequ√™ncia de asteroides de tamanhos diferentes e somar o XP recebido comparando com `GameConstants` para assegurar que o total corresponde ao plano calculado.

> Registrar na planilha de valida√ß√£o ou no changelog interno os resultados das verifica√ß√µes acima e manter o log do RewardManager ligado apenas durante a auditoria.

---

**Hist√≥rico da revis√£o:** Documento atualizado em 2025-10-05 ap√≥s validar o fluxo `RewardManager ‚Üí XPOrbSystem`.
