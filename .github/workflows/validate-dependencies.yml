name: Validate Dependencies

on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/**/*.js'
      - 'scripts/**/*.js'

jobs:
  analyze:
    name: Analyze dependency graph
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate dependency artifacts
        run: npm run analyze:deps

      - name: Fail build on dependency cycles
        run: |
          node <<'EOF'
          const fs = require('fs');

          if (!fs.existsSync('dependency-issues.json')) {
            console.error('dependency-issues.json não foi gerado. Execute "npm run analyze:deps" antes de validar.');
            process.exit(1);
          }

          const issues = JSON.parse(fs.readFileSync('dependency-issues.json', 'utf8'));

          if (Array.isArray(issues.cycles) && issues.cycles.length > 0) {
            console.error('Ciclos detectados:\n' + issues.cycles.join('\n'));
            process.exit(1);
          }
          EOF

      - name: Publish summary
        if: always()
        run: |
          if [ -f dependency-issues.json ]; then
            node <<'EOF'
            const fs = require('fs');

            const issues = JSON.parse(fs.readFileSync('dependency-issues.json', 'utf8'));

            const formatList = (list) => (list.length ? list.map((item) => `- ${item}`).join('\n') : '- Nenhum');

            const lines = [
              '## Dependency Analysis Summary',
              '',
              `Cycles detectados: ${issues.cycles.length}`,
              formatList(issues.cycles),
              '',
              `Hubs críticos: ${issues.hubs.length}`,
              formatList(issues.hubs),
              '',
              `Módulos órfãos: ${issues.orphans.length}`,
              formatList(issues.orphans),
            ];

            const summaryPath = process.env.GITHUB_STEP_SUMMARY;
            if (summaryPath) {
              fs.appendFileSync(summaryPath, `${lines.join('\n')}\n`);
            } else {
              console.log(lines.join('\n'));
            }
            EOF
          else
            if [ -n "$GITHUB_STEP_SUMMARY" ]; then
              echo "dependency-issues.json not found" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "dependency-issues.json not found"
            fi
          fi
        shell: bash

      - name: Upload dependency artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          if-no-files-found: warn
          path: |
            dependency-graph.json
            dependency-issues.json
            dependency-graph.dot
            docs/architecture/dependency-graph.mmd
